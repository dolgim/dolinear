#!/usr/bin/env sh

# $3 = flag: 1 = branch checkout / worktree add, 0 = file checkout
if [ "$3" != "1" ]; then
  exit 0
fi

# Find project root (where scripts/setup-db.sh lives)
PROJECT_ROOT="$(git rev-parse --show-toplevel 2>/dev/null)"
if [ -z "$PROJECT_ROOT" ] || [ ! -f "$PROJECT_ROOT/scripts/setup-db.sh" ]; then
  exit 0
fi

# Only run if Docker is available and the DB container is running
if ! docker compose -f "$PROJECT_ROOT/docker-compose.yml" ps -q db >/dev/null 2>&1; then
  echo "[post-checkout] PostgreSQL container is not running. Run 'pnpm db:up' then 'pnpm db:setup'."
  exit 0
fi

echo "[post-checkout] Setting up branch-specific database..."
bash "$PROJECT_ROOT/scripts/setup-db.sh" || {
  echo "[post-checkout] db:setup failed. Run 'pnpm db:setup' manually."
  exit 0
}
